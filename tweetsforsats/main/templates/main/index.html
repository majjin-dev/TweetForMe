<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Tweets For Sats</title>
    </head>
    <body {% if invoice_id or auth_url %}onload="startChecking()"{% endif %}>

        <h1>Welcome to Tweets for Sats</h1>
        {% if key %}
        {% load qr_code %}
        <a href="{% url 'lnlogin:logout' %}">Logout</a>
        <h2>Hello, @{{ key }}</h2>
        <h3>Pending: {{ balances.pending }} sats | {% if balances.available > 0 %}<a href="{% url 'main:index' %}?withdraw=true" onclick="">Available</a>{% else %}Available{% endif %}: {{ balances.available }} sats</h3>
        <h2>Recent Tweets:</h2>
        <ul>
            {% for tweet in recent %}
            <li><a href="https://twitter.com/TweetsForSats/status/{{ tweet.twitter_id }}">{{ tweet.twitter_id }}</a></li>
            {% endfor %}
        </ul>

        {% if auth_url %}
        
        <div id="auth">
            <h2>Authorize Withdrawal</h2>
            {% qr_from_text auth_url size="s" %}
        </div>

        <div id="withdrawal" style="display: none;">
            <h2>Withdraw sats!</h2>
            {% qr_from_text withdraw_url size="s" %}
        </div>

        <script>
            var interval;
            var status_interval;
            var timeout;

            function startChecking(){
                interval = setInterval(check, 2000);
                timeout = setTimeout(() => location.reload(), 120000);
            }

            function check() {
                fetch("{% url 'lnlogin:check' %}?k1={{ challenge }}")
                .then(response => response.json())
                .then(function(data){
                    if (data.authenticated == true){
                        clearInterval(interval);
                        clearTimeout(timeout);
                        document.getElementById("auth").style.display = "None";
                        document.getElementById("withdrawal").style.display = "Block";
                        status_interval = setInterval(status, 2000);
                    }
                });
            }

            function status() {
                fetch("{% url 'main:withdraw_status' challenge %}")
                .then(response => response.json())
                .then(function(data){
                    if (data.status != "WAIT"){
                        location.replace("{% url 'main:index' %}")
                    }
                });
            }
        </script>

        {% endif %}

        {% if not auth_url %}
        <button type="button" id="tweetBtn" onclick="get_invoice()">Tweet!</button>
        {% endif %}

        {% if invoice_id %}
        <div id="invoice">
            {% qr_from_text invoice size="s" %}
            <h3>Expires in <span id="timer">90</span> seconds</h3>
        </div>

        <div id="tweet" style="display: none;">
            <form action="{% url 'main:tweet' %}" method="post">
                {% csrf_token %}
                {{ form.as_p }}
                <input type="submit" value="Submit">
            </form>
        </div>

        <script>
            var interval;
            var timer_interval;
            var timer_set = 90;

            function startChecking(){
                interval = setInterval(check, 2000);
                timer_interval = setInterval(timer, 1000);
            }

            function check() {
                fetch("{% url 'main:checkinvoice' invoice_id %}")
                .then(response => response.json())
                .then(function(data){
                    if (data.status == "Paid"){
                        clearInterval(interval);
                        clearInterval(timer_interval);
                        var invoice = document.getElementById("invoice");
                        invoice.style.display = "None";
                        var tweet = document.getElementById("tweet");
                        tweet.style.display = "block";
                        var tweetBtn = document.getElementById("tweetBtn");
                        tweetBtn.style.display = "None";
                    }
                    else if (data.status == "Expired"){
                        clearInterval(interval);
                        location.reload();
                    }
                });
            }

            function timer(){
                timer_set = timer_set - 1;
                document.getElementById("timer").innerHTML = timer_set;
                if (timer_set == 0){
                    clearInterval(timer_interval);
                }
            }
        </script>
        {% endif %}

        <script>
            function get_invoice(){
                window.location.replace("{% url 'main:index' %}?invoice=true");
            }
        </script>
        {% else %}
        <a href="{% url 'lnlogin:login' %}">Login</a>
        {% endif %}
    </body>
</html>